# reset
rm(list = ls())

# load packages
require(tidyverse)
require(sf)
require(osmdata)
require(cartography)
require(units)

# define a bounding box
m <- matrix(c(79, 26, 88.5, 30.5), ncol = 2, byrow = TRUE)
row.names(m) <- c("x", "y")
names(m) <- c("min", "max")


# Get the country
q.nepal <- m %>% 
  opq() %>% 
  add_osm_feature(key = 'name:en', value = 'Nepal') %>% 
  osmdata_sf()

nepal <- q.nepal$osm_multipolygons

# get the admin levels
# Province
q.province <- m %>% 
  opq() %>% 
  add_osm_feature(key = 'admin_level', value = '3') %>% 
  osmdata_sf()

province <- q.province$osm_multipolygons

# district (still to be confirmed that this is it....)
q.district <- m %>% 
  opq() %>% 
  add_osm_feature(key = 'admin_level', value = '6') %>% 
  osmdata_sf()

district <- q.district$osm_multipolygons


# get points of interest (need to clean these after by crossing with Nepal)
# banks
q.banks <- m %>% 
  opq() %>% 
  add_osm_feature("amenity", "bank") %>% 
  osmdata_sf()
plot(banks)
banks <- q.banks$osm_points

# hospitals
q.hospitals <- m %>% 
  opq() %>% 
  add_osm_feature("amenity", "hospital") %>% 
  osmdata_sf()

hospitals <- q.hospitals$osm_points

# clinics
q.clinics <- m %>% 
  opq() %>% 
  add_osm_feature("amenity", "clinic") %>% 
  osmdata_sf()

clinics <- q.clinics$osm_points

# markets
q.markets <- m %>% 
  opq() %>% 
  add_osm_feature("amenity", "marketplace") %>% 
  osmdata_sf()

markets <- q.markets$osm_points


#roads - to be completed
q.highways <- m %>%
  opq() %>%
  add_osm_feature("highway", "primary") %>%
  osmdata_sf()

highways <- q.highways$osm_lines

## clean data

# double-check to ensure that everything is using the same projection, convert to all the same projection
st_crs(banks)


# keep only points of interest within Nepal
district <- st_intersection(x = district, y = nepal)
banks <- st_intersection(x = banks, y = nepal)
clinics <- st_intersection(x = clinics, y = nepal)
hospitals <- st_intersection(x = hospitals, y = nepal)
markets <- st_intersection(x = markets, y = nepal)
highways <- st_intersection(x = highways, y = nepal)


# SAE <- st_read(dsn = "C:/Users/moctar.aboubacar/Desktop/Nepal SAE~Palika/SAE_WFP_WB_2011", layer = "SAE_palika_WFP_WB_both_2011")

save(list = c("nepal", "province", "district", "banks", "hospitals", "clinics", "markets"),
     file = "C:/Users/moctar.aboubacar/Desktop/nepalosm.RData")


# try a plot with  different things
plot(st_geometry(nepal), col = "grey80", border = NA, bg = "grey95")
plot(province[1], col = "grey80", add = T)
plot(district[1], col = "grey90", add = T)
plot(banks[1], col = rgb(red = 1, green = 0, blue = 0, alpha = 0.4), pch = 19, cex = .5, add = T)
plot(hospitals[1], col = rgb(red = 0, green = 0, blue = 1, alpha = 0.4), pch = 19, cex = .5, add = T)
plot(markets[1], col = rgb(red = 0, green = 1, blue = 0, alpha = 0.4), pch = 19, cex = .8, add = T)
plot(highways[1], col = "black", lwd = 2, add = T)

# try a chroropleth by province

# count the # of things in each province & fuse it with the province
district$n_banks <- lengths(st_covers(district, banks))
district$n_hospitals <- lengths(st_covers(district, hospitals))
district$n_clinics <- lengths(st_covers(district, clinics))
district$n_markets <- lengths(st_covers(district, markets))

# log

district$ln_banks <- log(district$n_banks)
district$ln_hospitals <- log(district$n_hospitals)
district$ln_clinics <- log(district$n_clinics)
district$ln_markets <- log(district$n_markets)


# mapping

par(mfrow = c(2, 2))

choroLayer(district, var = "n_banks",
           method = "fisher-jenks", nclass = 7,
           col = carto.pal("wine.pal", 7))

choroLayer(district, var = "n_hospitals",
           method = "fisher-jenks", nclass = 7,
           col = carto.pal("wine.pal", 7))

choroLayer(district, var = "n_clinics",
           method = "fisher-jenks", nclass = 7,
           col = carto.pal("wine.pal", 7))

choroLayer(district, var = "n_markets",
           method = "fisher-jenks", nclass = 7,
           col = carto.pal("wine.pal", 7))


# Here's the problem: we don't have enough variability just plotting the number of things in each territory.
# so we will (1) try putting it as the log number of items, instead of just the items (2) the borders in the maps are still weird. (3) make the colors better



# try with sf and ggplot (log scale)
ggplot(district)+
  geom_sf(aes(fill = ln_banks))+
  theme_void()

ggplot(district)+
  geom_sf(aes(fill = ln_hospitals))+
  theme_void()

ggplot(district)+
  geom_sf(aes(fill = ln_clinics))+
  theme_void()

ggplot(district)+
  geom_sf(aes(fill = ln_markets))+
  theme_void()

par(mfrow = c(1, 1))



# final product at this stage: extracting data, cleaning data + shapefile calculations, vizualization (choropleth + smoothed thingy, 2 x 4 maps, + 1 basic map w/ everything)


# narrative: there is a lot of undercoverage, so there will be large problems and assumptions in making a vulnerability analysis valid, b/c missing data.




