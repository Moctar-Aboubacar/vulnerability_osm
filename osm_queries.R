# reset
rm(list = ls())

# load packages
require(tidyverse)
require(sf)
require(osmdata)
require(cartography)
require(units)

# define a bounding box
m <- matrix(c(79, 26, 88.5, 30.5), ncol = 2, byrow = TRUE)
row.names(m) <- c("x", "y")
names(m) <- c("min", "max")


# Get the country
q.nepal <- m %>% 
  opq() %>% 
  add_osm_feature(key = 'name:en', value = 'Nepal') %>% 
  osmdata_sf()

nepal <- q.nepal$osm_multipolygons

# get the admin levels
# Province
q.province <- m %>% 
  opq() %>% 
  add_osm_feature(key = 'admin_level', value = '3') %>% 
  osmdata_sf()

province <- q.province$osm_multipolygons

# district (still to be confirmed that this is it....)
q.district <- m %>% 
  opq() %>% 
  add_osm_feature(key = 'admin_level', value = '6') %>% 
  osmdata_sf()

district <- q.district$osm_multipolygons


# get points of interest

# banks
q.banks <- m %>% 
  opq() %>% 
  add_osm_feature("amenity", "bank") %>% 
  osmdata_sf()
plot(banks)
banks <- q.banks$osm_points

# hospitals
q.hospitals <- m %>% 
  opq() %>% 
  add_osm_feature("amenity", "hospital") %>% 
  osmdata_sf()

hospitals <- q.hospitals$osm_points

# clinics
q.clinics <- m %>% 
  opq() %>% 
  add_osm_feature("amenity", "clinic") %>% 
  osmdata_sf()

clinics <- q.clinics$osm_points

# markets
q.markets <- m %>% 
  opq() %>% 
  add_osm_feature("amenity", "marketplace") %>% 
  osmdata_sf()

markets <- q.markets$osm_points

# road data was hard to get, as Overpass was constantly either timing out or telling me that memory was insufficient to continue (I subsequently learned that this can be addressed by tweaking the maxsize setting in Overpass). The alternative here is to simply directly download a country or area extract through one of the links on this list (https://wiki.openstreetmap.org/wiki/Planet.osm#Country_and_area_extracts). Most of these sources of updated daily or more frequently, so more than enough for our needs here. We could have extracted all the data above from this information, but where would be the fun in that? Also, this method is a little brute-force, as it involes simply downloading everything within Nepal.
#The resulting file format for the bounding box specified is in PBF ()


q.roads_prim <- m %>%
 opq(timeout = 50) %>%
 add_osm_feature("highway", "primary") %>%
 osmdata_sf()
 
roads_prim <- q.roads_prim$osm_lines

q.roads_trunk <- m %>% 
  opq(timeout = 50) %>% 
  add_osm_feature("highway", "trunk") %>% 
  osmdata_sf()

roads_trunk <- q.roads_trunk$osm_lines

q.roads_sec <- m %>% 
  opq(timeout = 50) %>% 
  add_osm_feature("highway", "secondary") %>% 
  osmdata_sf()

roads_sec <- q.roads_sec$osm_lines
plot(roads_sec[1])

## clean and save data

# confirm that all objects are using the same projection
st_crs(nepal)
st_crs(district)
st_crs(SAE)
st_crs(banks)
st_crs(hospitals)
st_crs(clinics)
st_crs(markets)

# keep only points of interest within Nepal
district <- st_intersection(x = district, y = nepal)
banks <- st_intersection(x = banks, y = nepal)
clinics <- st_intersection(x = clinics, y = nepal)
hospitals <- st_intersection(x = hospitals, y = nepal)
markets <- st_intersection(x = markets, y = nepal)

roads_prim <- st_intersection(x = roads_prim, y = nepal)
roads_trunk <- st_intersection(x = roads_trunk, y = nepal)
roads_sec <- st_intersection(x = roads_sec, y = nepal)


# a basic plot of everything (w/o SAE data)
plot(st_geometry(nepal), col = "grey80", border = NA)
#plot(province[1], col = "grey80", add = T)
plot(district[1], col = "grey90", add = T)
plot(roads_trunk[1], col = "black", lwd = 2, add = T)
plot(roads_prim[1], col = "grey20", lwd = 1.8, add = T)
plot(roads_sec[1], col = "grey60", lwd = 1.5, add = T)

plot(banks[1], col = rgb(red = 1, green = 0, blue = 0, alpha = 0.4), pch = 19, cex = .7, add = T)
plot(hospitals[1], col = rgb(red = 1, green = 0, blue = 0, alpha = 0.4), pch = 19, cex = .7, add = T)
plot(clinics[1], col = rgb(red = 0, green = 0, blue = 1, alpha = 0.4), pch = 19, cex = .7, add = T)

plot(markets[1], col = rgb(red = 0, green = 1, blue = 0, alpha = 0.4), pch = 19, cex = .7, add = T)


# put everything into SAE data
SAE <- st_read(dsn = "C:/Users/moctar.aboubacar/Desktop/Nepal SAE~Palika/SAE_WFP_WB_2011", layer = "SAE_palika_WFP_WB_both_2011")

# counts of each point of interest by Palika
SAE$banks <- lengths(st_covers(SAE, banks))
SAE$hospitals <- lengths(st_covers(SAE, hospitals))
SAE$clinics <- lengths(st_covers(SAE, clinics))
SAE$markets <- lengths(st_covers(SAE, markets))

save(list = c("nepal", "province", "district", "banks", "hospitals", "clinics", "markets", "roads_trunk","roads_prim", "roads_sec", "SAE"),
     file = "C:/Users/moctar.aboubacar/Desktop/nepalosm.RData")


# by-district











# 1 get good road data (more than just main roads)
# 2 put road data length into SAE
# 3 divide data into complete (more or less complete OSM) and incomplete (missing data that I suspect is because of lack of mapping)- roads are one good proxy for completeness...maybe just group by district or something though. Capture the things that do seem to be captured in the north in Humla

# 4 get by-palika population estimates for all palikas (Maan)
# 5 Train a model to predict clinic counts (poisson or zero-inflated poisson I think), and test it on the has-road data (pop, SAE scores, markets, banks...think of some others!!)
# 6 predict counts of clinics per palika

# 7 ## Now this will blow your mind... Once you apply your model (one for clinics, one for banks, etc etc) to all the palikas in the non-road prediction group, then you take the WHOLE dataset--the real results for the palikas that are complete and the predicted results for the others.... AND YOU DO A VULNERABILITY ANALYSIS-- could be clustering, could be something else.

# to sum up, I'm doing 3 things:
# (1) extracting OSM data and visualizing it (finish by 9 Feb & upload)
# (2) predicting PoI counts for areas where data is missing (finish by 23 feb)
# (3) doing a ~ clustering or other vulnerability analysis to get different types of palikas (finish by 23 March)




# final product at this stage: extracting data, cleaning data + shapefile calculations, vizualization (choropleth + smoothed thingy, 2 x 4 maps, + 1 basic map w/ everything)


# narrative: there is a lot of undercoverage, so there will be large problems and assumptions in making a vulnerability analysis valid, b/c missing data.




